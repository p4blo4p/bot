name: ğŸ” URLWatch Monitoring - Detailed Tracking

on:
  schedule:
    # Ejecutar cada 6 horas
    - cron: '0 */6 * * *'
  workflow_dispatch: # Permitir ejecuciÃ³n manual
  
env:
  TZ: Europe/Madrid

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Necesario para el historial
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install dependencies
      run: |
        pip install urlwatch PyYAML

    - name: ğŸ“ Create directories
      run: |
        mkdir -p logs
        mkdir -p .urlwatch

    - name: ğŸ”§ Setup URLWatch configuration
      run: |
        # Crear configuraciÃ³n detallada
        cat > .urlwatch/config.yaml << 'EOF'
        display:
          new: true
          error: true
          unchanged: false
          empty-diff: true
        
        report:
          text:
            line_length: 120
            details: true
            footer: true
            minimal: false
        
        storage:
          minidb:
            filename: .urlwatch/cache.db
            
        reporters:
          - text:
              filename: logs/detailed_report.txt
              details: true
        EOF

    - name: ğŸ“ Create default URLs configuration 
      run: |
        # Crear archivo de URLs con solo las definiciones de jobs
        cat > .urlwatch/urls.yaml << 'EOF'
        name: "Oposiciones UCA - InformÃ¡tica"
        url: "https://personal.uca.es/oposiciones-turno-libre/"
        timeout: 30
        filter:
          - html2text
          - grep: "informÃ¡tica"
          - strip
        ---
        name: "Cursos INAP - InformÃ¡tica"  
        url: "https://buscadorcursos.inap.es/#/?abierto=true&funcion=6"
        timeout: 30
        filter:
          - html2text
          - grep: "(?i)informÃ¡tica|sistemas|tecnolog"
          - strip
        ---
        name: "Ayto Puerto Real - TablÃ³n"
        url: "https://puertoreal.sedelectronica.es/board" 
        timeout: 30
        filter:
          - html2text
          - grep: "(?i)informÃ¡tica|tÃ©cnico|sistemas"
          - strip
        ---
        name: "Ayto Puerto Real - OPE"
        url: "https://puertoreal.es/oferta-publica-de-empleo/"
        timeout: 30
        filter:
          - html2text  
          - grep: "(?i)informÃ¡tica|tÃ©cnico|sistemas"
          - strip
        ---
        name: "BOE - BÃºsqueda Oposiciones"
        url: "https://www.boe.es/buscar/doc.php?coleccion=boe&modo=ultimosdias&tm=4"
        timeout: 30
        filter:
          - html2text
          - grep: "(?i)informÃ¡tica|sistemas|tecnolog|tÃ©cnico superior|oposiciÃ³n"
          - strip
        ---
        name: "Junta de AndalucÃ­a - FunciÃ³n PÃºblica"
        url: "https://www.juntadeandalucia.es/organismos/funcionpublica/"
        timeout: 30
        filter:
          - html2text
          - grep: "(?i)informÃ¡tica|sistemas|tecnolog|oposiciÃ³n"
          - strip
        EOF

    - name: ğŸ”„ Extract jobs from custom URLs file
      run: |
        # Si existe un archivo urls2watch.yaml personalizado, extraer solo los jobs
        if [ -f "urls2watch.yaml" ]; then
          echo "ğŸ”„ Detectado urls2watch.yaml personalizado, extrayendo jobs..."
          python extract_jobs.py
        fi

    - name: ğŸ—‚ï¸ Load previous cache if exists
      run: |
        # Si existe cache anterior en el repo, restaurarlo
        if [ -f "cache.db" ]; then
          cp cache.db .urlwatch/cache.db
          echo "âœ… Cache anterior restaurado"
        else
          echo "â„¹ï¸ No hay cache anterior, iniciando desde cero"
        fi

    - name: ğŸ” Run URLWatch monitoring
      run: |
        echo "ğŸš€ Iniciando monitoreo URLWatch..."
        urlwatch --config .urlwatch/config.yaml --urls .urlwatch/urls.yaml --cache .urlwatch/cache.db --verbose > logs/urlwatch_$(date +%Y%m%d_%H%M%S).txt 2>&1 || true
        echo "âœ… Monitoreo completado"

    - name: ğŸ“ˆ Analyze changes and generate detailed report
      run: |
        python track_changes.py
        
        # Crear resumen mejorado con nombres reales y URLs clickables
        cat > logs/summary.md << EOF
        # ğŸ“Š URLWatch Monitoring Summary

        **Generated:** $(date '+%d/%m/%Y %H:%M:%S')
        **Status:** âœ… Monitoring completed successfully

        ## Recent Activity

        ### Latest Execution Log
        \`$(ls -t logs/urlwatch_*.txt | head -n1 | xargs basename)\`

        ## Monitored Sites

        ### Detailed Status
        \`\`\`
        EOF
        
        # Extraer URLs y nombres del archivo de configuraciÃ³n
        grep -A 1 "^name:" .urlwatch/urls.yaml | paste - - | while read name url; do
          name_clean=$(echo "$name" | sed 's/name: //; s/"//g')
          url_clean=$(echo "$url" | sed 's/url: //; s/"//g')
          
          # Buscar informaciÃ³n en el archivo de estado
          if [ -f "logs/sites_status.txt" ]; then
            site_info=$(grep -A 5 "$url_clean" logs/sites_status.txt 2>/dev/null || grep -A 5 "$name_clean" logs/sites_status.txt 2>/dev/null || echo "")
            
            if [ -n "$site_info" ]; then
              last_check=$(echo "$site_info" | grep "Ãšltima verificaciÃ³n:" | cut -d: -f2- | sed 's/^ *//')
              status=$(echo "$site_info" | grep "Estado:" | cut -d: -f2- | sed 's/^ *//')
              data_size=$(echo "$site_info" | grep "TamaÃ±o datos:" | cut -d: -f2- | sed 's/^ *//')
              total_checks=$(echo "$site_info" | grep "Total verificaciones:" | cut -d: -f2- | sed 's/^ *//')
              
              echo "================================================================================" >> logs/summary.md
              echo "ğŸ” $name_clean" >> logs/summary.md
              echo "ğŸŒ [$url_clean]($url_clean)" >> logs/summary.md
              echo "ğŸ“… Ãšltima verificaciÃ³n: $(date '+%d/%m/%Y %H:%M:%S')" >> logs/summary.md
              echo "âœ… Estado: $status" >> logs/summary.md
              echo "ğŸ“ TamaÃ±o datos: $data_size" >> logs/summary.md
              echo "ğŸ”„ Ãšltima verificaciÃ³n sin cambios: $last_check" >> logs/summary.md
              echo "ğŸ“Š Total verificaciones: $total_checks" >> logs/summary.md
              echo "------------------------------------------------------------" >> logs/summary.md
              echo "" >> logs/summary.md
            else
              echo "================================================================================" >> logs/summary.md
              echo "ğŸ” $name_clean" >> logs/summary.md
              echo "ğŸŒ [$url_clean]($url_clean)" >> logs/summary.md
              echo "ğŸ“… Ãšltima verificaciÃ³n: $(date '+%d/%m/%Y %H:%M:%S')" >> logs/summary.md
              echo "âœ… Estado: âœ… OK" >> logs/summary.md
              echo "ğŸ“ TamaÃ±o datos: 0 bytes" >> logs/summary.md
              echo "ğŸ”„ Ãšltima verificaciÃ³n sin cambios: $(date '+%d/%m/%Y %H:%M:%S')" >> logs/summary.md
              echo "ğŸ“Š Total verificaciones: 1" >> logs/summary.md
              echo "------------------------------------------------------------" >> logs/summary.md
              echo "" >> logs/summary.md
            fi
          fi
        done
        
        echo "\`\`\`" >> logs/summary.md
        
        # Crear versiÃ³n legible adicional
        cat >> logs/summary.md << EOF
        
        ## ğŸ“‹ Detailed Status (Readable Format)
        
        EOF
        
        grep -A 1 "^name:" .urlwatch/urls.yaml | paste - - | while read name url; do
          name_clean=$(echo "$name" | sed 's/name: //; s/"//g')
          url_clean=$(echo "$url" | sed 's/url: //; s/"//g')
          
          echo "### ğŸ” $name_clean" >> logs/summary.md
          echo "" >> logs/summary.md
          echo "- **URL:** [$url_clean]($url_clean)" >> logs/summary.md
          echo "- **Ãšltima verificaciÃ³n:** $(date '+%d/%m/%Y %H:%M:%S')" >> logs/summary.md
          echo "- **Estado:** âœ… OK" >> logs/summary.md
          echo "- **Ãšltimo cambio:** $(date '+%d/%m/%Y %H:%M:%S')" >> logs/summary.md
          echo "- **Ãšltima verificaciÃ³n sin cambios:** $(date '+%d/%m/%Y %H:%M:%S')" >> logs/summary.md
          echo "- **Total verificaciones:** 1" >> logs/summary.md
          echo "" >> logs/summary.md
          echo "---" >> logs/summary.md
          echo "" >> logs/summary.md
        done

    - name: ğŸ“¦ Upload reports as artifacts (v4)
      uses: actions/upload-artifact@v4
      with:
        name: urlwatch-reports-${{ github.run_number }}
        path: |
          logs/*.md
          logs/*.txt
          logs/*.json
        retention-days: 30

    - name: ğŸ’¾ Backup cache for next run
      run: |
        # Copiar cache al repo para persistirlo
        if [ -f ".urlwatch/cache.db" ]; then
          cp .urlwatch/cache.db cache.db
          echo "âœ… Cache guardado para prÃ³xima ejecuciÃ³n"
        fi

    - name: ğŸ—‚ï¸ Organize log files
      run: |
        # Mantener solo los Ãºltimos 10 archivos de log
        cd logs
        ls -t urlwatch_*.txt | tail -n +11 | xargs -r rm --
        echo "ğŸ§¹ Archivos antiguos limpiados"

    - name: ğŸ“¤ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add logs/ cache.db || true
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No hay cambios para commitear"
        else
          TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
          
          if ls logs/urlwatch_*.txt | xargs grep -l "ERROR:" | tail -n1 > /dev/null 2>&1; then
            COMMIT_MSG="ğŸ” URLWatch monitoring update âš ï¸  - ${TIMESTAMP}"
          else
            COMMIT_MSG="ğŸ” URLWatch monitoring update âœ… - ${TIMESTAMP}"
          fi
          
          git commit -m "$COMMIT_MSG" || true
          git push || true
          echo "âœ… Cambios enviados al repositorio"
        fi

    - name: ğŸ“Š Display summary
      run: |
        echo "=================================="
        echo "ğŸ¯ RESUMEN DE EJECUCIÃ“N"
        echo "=================================="
        echo "ğŸ“… Fecha: $(date '+%d/%m/%Y %H:%M:%S')"
        echo "ğŸ”— URLs monitoreadas: $(grep -c '^name:' .urlwatch/urls.yaml)"
        echo "ğŸ“ Archivos de log: $(ls logs/ | wc -l)"
        
        if [ -f "logs/sites_status.txt" ]; then
          echo ""
          echo "ğŸ“‹ Estado actual de sitios:"
          grep -E "^ğŸ“Š|^âœ…" logs/sites_status.txt | head -12 || true
        fi
